<!doctype html>
<html lang="ja" data-default-lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title id="title">色で選ぶ5分の詩 — Mind Space</title>
  <meta name="description" id="desc" content="RGBカラーパレットから色を選び、世界の短い詩を一篇。原文＋あなたの言語で静かに読む。"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.72);backdrop-filter:blur(8px);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .dot{width:24px;height:24px;border-radius:9999px;border:1px solid rgba(15,23,42,.12)}
    pre{white-space:pre-wrap}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-white to-slate-50 text-slate-800">
  <header class="mx-auto max-w-4xl px-4 py-4 flex items-center justify-between">
    <!-- ▼ href はダミーにし、JSで安全なホームURLに書き換えます -->
    <a id="backLink" href="#" class="text-sm hover:underline">&larr; <span id="back">ホームへ戻る</span></a>
    <button id="lang" class="text-xs px-3 py-1 rounded-full border border-slate-200">English</button>
  </header>

  <main class="mx-auto max-w-4xl px-4 pb-16">
    <h1 class="text-2xl font-semibold" id="h1">色で選ぶ 5分の詩</h1>
    <p class="mt-2 text-slate-600" id="lead">下の<strong>RGBカラーパレット</strong>から色を選ぶと、世界の短い詩を一篇だけ。原文と日本語/英語で静かに読む時間を。</p>

    <section class="card p-5 mt-5">
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <label class="text-sm">
          <span id="pick">色を選ぶ（RGBパレット）</span><br/>
          <input id="picker" type="color" value="#5FA8FF" class="mt-1 h-10 w-20 p-0 border rounded">
        </label>

        <div class="text-sm text-slate-700">
          <div class="flex items-center gap-2">
            <span class="dot" id="chip" style="background:#5FA8FF"></span>
            <code id="hex" class="text-xs text-slate-500">#5FA8FF</code>
          </div>
        </div>

        <div class="md:ml-auto">
          <button id="btnNew" class="px-3 py-1.5 rounded border hover:bg-white">詩を表示</button>
        </div>
      </div>
    </section>

    <section class="card p-6 mt-6">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-medium" id="poemTitle">—</h2>
          <div class="text-sm text-slate-500" id="poemMeta">—</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="toggleLang" class="text-xs px-3 py-1 rounded-full border">原文 / 訳</button>
        </div>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <pre id="orig" class="text-sm leading-7 p-4 rounded bg-white/60 border"></pre>
        <pre id="tran" class="text-sm leading-7 p-4 rounded bg-white/60 border"></pre>
      </div>
    </section>

    <p class="mt-4 text-xs text-slate-500">
      ※ 原文は<strong>パブリックドメイン</strong>から取得。短い抜粋を表示し、訳はUIの言語に忠実に表示します（人間訳があれば優先します）。出典リンクはカード上部に表示します。
    </p>
  </main>

  <script>
    // ===== ルート自動判定（GitHub Pages と Netlify 両対応） =====
    const isGitHubPages = location.hostname.endsWith('github.io');
    const BASE = isGitHubPages ? '/mind-space' : '';

    // ===== i18n =====
    const dict={
      ja:{title:"色で選ぶ5分の詩 — Mind Space",desc:"RGBカラーパレットから色を選び、世界の短い詩を一篇。原文＋あなたの言語で静かに読む。",
          back:"ホームへ戻る",h1:"色で選ぶ 5分の詩",
          lead:"下のRGBカラーパレットから色を選ぶと、世界の短い詩を一篇だけ。原文と日本語/英語で静かに読む時間を。",
          pick:"色を選ぶ（RGBパレット）",btnNew:"詩を表示",toggle:"English",toggleOT:"原文 / 訳"},
      en:{title:"Color-picked 5-minute poem reset — Mind Space",desc:"Pick a color; get one short public-domain poem in original + your language.",
          back:"Back to Home",h1:"5-minute poem reset by color",
          lead:"Pick a color from the RGB palette to receive one short public-domain poem. Read in original + English/Japanese.",
          pick:"Pick a color (RGB palette)",btnNew:"Show poem",toggle:"日本語",toggleOT:"Original / Translation"}
    };
    const $=id=>document.getElementById(id);
    let uiLang="ja"; if(navigator.language?.startsWith("en")) uiLang="en";

    function applyUI(){
      document.title=dict[uiLang].title; $("desc").setAttribute("content",dict[uiLang].desc);
      ["back","h1","lead","pick"].forEach(k=>{$(k).textContent=dict[uiLang][k];});
      $("btnNew").textContent=dict[uiLang].btnNew;
      $("toggleLang").textContent = dict[uiLang].toggleOT;
      $("lang").textContent = dict[uiLang].toggle;
      document.documentElement.lang=uiLang;

      // ▼ ホームへの戻り先を現在のホストに合わせて更新（UI言語がenなら ?lang=en を付与）
      const homeUrl = BASE + "/" + (uiLang === "en" ? "?lang=en" : "");
      const backA = $("backLink");
      if (backA) backA.setAttribute("href", homeUrl);
    }

    // ===== HSV変換 =====
    function hexToHSV(hex){
      const c=hex.replace("#",""); const r=parseInt(c.slice(0,2),16)/255, g=parseInt(c.slice(2,4),16)/255, b=parseInt(c.slice(4,6),16)/255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min; let h=0;
      if(d!==0){ if(max===r) h=((g-b)/d)%6; else if(max===g) h=(b-r)/d+2; else h=(r-g)/d+4; h*=60; if(h<0) h+=360;}
      const s=max===0?0:d/max; const v=max; return {h,s,v};
    }

    // ===== ムード判定（内部のみ使用） =====
    function hsvToMood({h,s,v}){
      if(v < 0.20) return "reflect";
      if(s < 0.20) return (v > 0.85 ? "fresh" : "calm");
      if(h < 15)  return (s>0.5 && v>0.6) ? "passion" : "vital";
      if(h < 45)  return (s>0.5 && v>0.6) ? "vital"   : "passion";
      if(h < 70)  return (s>0.4) ? "vital" : "fresh";
      if(h < 160) return (s>0.4) ? "calm"  : "fresh";
      if(h < 210) return "fresh";
      if(h < 260) return (s>0.35) ? "fresh" : "reflect";
      if(h < 300) return (s>0.35) ? "reflect" : "calm";
      return "reflect";
    }

    // ===== 状態 =====
    const WORKER_BASE = "https://small-mode-829d.rabbitmrr.workers.dev";
    const ALLOW_HOSTS = ["en.wikisource.org","ja.wikisource.org","fr.wikisource.org","zh.wikisource.org","poetrydb.org","www.gutenberg.org"];
    let currentMood="fresh", showOriginal=true;

    function updateFromColor(hex){
      $("chip").style.background = hex;
      $("hex").textContent = hex.toUpperCase();
      currentMood = hsvToMood(hexToHSV(hex));
    }

    function withTimeout(promise, ms=5000){
      const to = new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), ms));
      return Promise.race([promise, to]);
    }

    async function getOnlinePoem(mood, uiLang){
      const url = `${WORKER_BASE}/api/poem?mood=${encodeURIComponent(mood)}&lang=${encodeURIComponent(uiLang)}`;
      const res = await withTimeout(fetch(url, {headers:{"accept":"application/json"}}), 6500);
      if(!res.ok) throw new Error("net");
      const j = await res.json();
      if(!j.ok || !j.poem) throw new Error("notfound");
      const p = j.poem;
      try{
        const host = new URL(p.source_url).host;
        if(!ALLOW_HOSTS.includes(host)) throw new Error("host");
      }catch{ throw new Error("host"); }
      return p;
    }

    async function getLocalPoem(mood, uiLang){
      const res = await fetch("./poems.json", {cache:"no-store"});
      const arr = await res.json();
      const cand = arr.filter(x => (x.mood || []).includes(mood));
      const pick = cand.length ? cand[Math.floor(Math.random()*cand.length)] : arr[Math.floor(Math.random()*arr.length)];
      return {
        title: pick.title, author: pick.author,
        original: pick.original, translation: (uiLang==="ja" ? pick.ja : pick.en) || null,
        source_url: pick.source_url || ""
      };
    }

    async function loadPoem(mood, uiLang){
      $("poemTitle").textContent = uiLang==="ja" ? "検索中…" : "Searching…";
      $("poemMeta").textContent = "";
      $("orig").textContent = ""; $("tran").textContent = "";
      try{
        const p = await getOnlinePoem(mood, uiLang);
        $("poemTitle").textContent = (p.title_localized || p.title || "—");
        $("poemMeta").innerHTML = `${p.author} · <a href="${p.source_url}" target="_blank" class="underline">${new URL(p.source_url).host}</a>`;
        $("orig").textContent = p.original || "";
        $("tran").textContent = p.translation || "";
      }catch(_e){
        const p = await getLocalPoem(mood, uiLang);
        $("poemTitle").textContent = (p.title || "—") + (uiLang==="ja" ? "（ローカル）" : " (local)");
        $("poemMeta").innerHTML = `${p.author}` + (p.source_url ? ` · <a href="${p.source_url}" target="_blank" class="underline">${new URL(p.source_url).host}</a>` : "");
        $("orig").textContent = p.original || "";
        $("tran").textContent = p.translation || "";
      }
    }

    // 初期化
    applyUI();
    updateFromColor($("picker").value);

    // イベント
    $("btnNew").addEventListener("click", ()=> loadPoem(currentMood, uiLang));
    $("picker").addEventListener("input", e=> updateFromColor(e.target.value));
    $("toggleLang").addEventListener("click", ()=>{
      showOriginal = !showOriginal;
      const o=$("orig"), t=$("tran");
      o.parentElement.style.order = showOriginal?0:1; t.parentElement.style.order = showOriginal?1:0;
    });
    $("lang").addEventListener("click", ()=>{
      uiLang = (uiLang==="ja"?"en":"ja");
      applyUI(); // 言語変更に合わせてホームリンクも更新されます
    });
  </script>
</body>
</html>
