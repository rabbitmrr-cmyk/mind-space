<!doctype html>
<html lang="ja" data-default-lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>3分サウンド — Mind Space</title>
  <meta name="description" content="耳にやさしい短いサウンドスケープ。雨・ブラウンノイズ・小鳥・温かいチャイム。±で配分とチャイム間隔を調整、3分タイマー付き。"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.72);backdrop-filter:blur(8px);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .btn{border:1px solid #e2e8f0;border-radius:9999px;padding:.35rem .7rem}
    .btn:disabled{opacity:.5}
    .row{display:grid;grid-template-columns:1fr auto auto auto 68px;gap:.5rem;align-items:center}
    .bar{height:8px;background:linear-gradient(90deg,#bae6fd,#e2e8f0);border-radius:9999px;overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#38bdf8,#60a5fa)}
    .chip{padding:.2rem .6rem;border:1px solid #e2e8f0;border-radius:9999px;background:#fff;font-size:.8rem}
    .chip.active{border-color:#60a5fa;background:#eff6ff}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-white to-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/40 border-b border-slate-200/40">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <a id="homeLink" class="text-sm hover:underline">&larr; ホームへ戻る</a>
      <button id="lang" class="text-xs px-3 py-1 rounded-full border border-slate-200">English</button>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 pb-16">
    <h1 class="text-2xl md:text-3xl font-semibold mt-6" id="h1">3分サウンド</h1>
    <p class="mt-2 text-slate-600" id="lead">耳にやさしい短いサウンドのみ（雨／ブラウンノイズ／小鳥／ぽーんと鳴るチャイム）。±で配分とチャイム間隔を調整できます。</p>

    <!-- プレイヤー -->
    <section class="card p-5 mt-4">
      <div class="flex flex-wrap items-center gap-2">
        <button id="play" class="btn">▶ 再生</button>
        <button id="stop" class="btn" disabled>■ 停止</button>
        <span class="text-sm text-slate-500">/</span>
        <label class="text-sm flex items-center gap-2">
          <span id="durLabel">時間</span>
          <select id="minutes" class="border rounded px-2 py-1 text-sm">
            <option value="3">3分</option>
            <option value="5">5分</option>
            <option value="10">10分</option>
          </select>
        </label>
        <span class="ml-auto text-sm mono" id="remain">00:00</span>
      </div>
      <div class="bar mt-3"><div id="prog" class="fill"></div></div>

      <!-- プリセット -->
      <div class="mt-4 flex flex-wrap items-center gap-2 text-sm">
        <span class="text-slate-600" id="presetLabel">プリセット:</span>
        <button class="chip active" data-preset="calm">落ち着き</button>
        <button class="chip" data-preset="rain">雨</button>
        <button class="chip" data-preset="focus">集中</button>
        <button class="chip" data-preset="birds">小鳥</button>
        <button class="chip" data-preset="chime">チャイム中心</button>
      </div>

      <!-- ミキサー -->
      <div class="mt-4 grid gap-2">
        <!-- ラベル / - / + / Mute / 値 -->
        <div class="row">
          <div>雨（しとしと）</div>
          <button class="btn" data-dec="rain">−</button>
          <button class="btn" data-inc="rain">＋</button>
          <button class="btn" data-mute="rain">Mute</button>
          <div class="mono text-right"><span id="rainVal">30</span>%</div>
        </div>
        <div class="row">
          <div>ブラウンノイズ（遠い空調のように）</div>
          <button class="btn" data-dec="brown">−</button>
          <button class="btn" data-inc="brown">＋</button>
          <button class="btn" data-mute="brown">Mute</button>
          <div class="mono text-right"><span id="brownVal">25</span>%</div>
        </div>
        <div class="row">
          <div>小鳥（たまに鳴く）</div>
          <button class="btn" data-dec="birds">−</button>
          <button class="btn" data-inc="birds">＋</button>
          <button class="btn" data-mute="birds">Mute</button>
          <div class="mono text-right"><span id="birdsVal">10</span>%</div>
        </div>
        <div class="row">
          <div>チャイム（温かい “ぽーん”）</div>
          <button class="btn" data-dec="chime">−</button>
          <button class="btn" data-inc="chime">＋</button>
          <button class="btn" data-mute="chime">Mute</button>
          <div class="mono text-right"><span id="chimeVal">15</span>%</div>
        </div>
      </div>

      <!-- チャイム間隔 -->
      <div class="mt-4 grid gap-2" style="grid-template-columns:auto auto auto auto 1fr;">
        <div class="text-sm">チャイム間隔</div>
        <button class="btn" id="chimeSlow">−</button>
        <button class="btn" id="chimeFast">＋</button>
        <button class="btn" id="chimeOnce">今すぐ鳴らす</button>
        <div class="mono text-right text-sm"><span id="chimeInfo">約 5–8 秒に1回</span></div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Home link base ===== */
    const isGitHubPages = location.hostname.endsWith('github.io');
    const BASE = isGitHubPages ? '/mind-space' : '';
    document.getElementById('homeLink').href = BASE + '/';

    /* ===== i18n (簡易) ===== */
    const dict = {
      ja:{h1:"3分サウンド",lead:"耳にやさしい短いサウンドのみ（雨／ブラウンノイズ／小鳥／ぽーんと鳴るチャイム）。±で配分とチャイム間隔を調整できます。",dur:"時間",preset:"プリセット:",play:"▶ 再生",stop:"■ 停止",chimeNow:"今すぐ鳴らす",chimeLabel:(lo,hi)=>`約 ${lo}–${hi} 秒に1回`},
      en:{h1:"3-minute soundscape",lead:"Only gentle, short sounds (rain / brown noise / birds / warm chime). Adjust mix and chime interval with ±.",dur:"Duration",preset:"Presets:",play:"▶ Play",stop:"■ Stop",chimeNow:"Chime now",chimeLabel:(lo,hi)=>`every ~${lo}-${hi}s`}
    };
    const $ = id => document.getElementById(id);
    let ui = navigator.language?.startsWith('en') ? 'en' : 'ja';
    function applyUI(){
      $('h1').textContent = dict[ui].h1;
      $('lead').textContent = dict[ui].lead;
      $('durLabel').textContent = dict[ui].dur;
      $('presetLabel').textContent = dict[ui].preset;
      $('play').textContent = dict[ui].play;
      $('stop').textContent = dict[ui].stop;
      $('lang').textContent = (ui==='ja'?'English':'日本語');
      $('chimeOnce').textContent = dict[ui].chimeNow;
      $('chimeInfo').textContent = dict[ui].chimeLabel(chimeRange.lo, chimeRange.hi);
      document.documentElement.lang = ui;
    }
    $('lang').addEventListener('click', ()=>{ ui = (ui==='ja'?'en':'ja'); applyUI(); });
    const chimeRange = {lo:5, hi:8};
    applyUI();

    /* ===== Web Audio Core ===== */
    let ctx, master, running=false, endAt=0, rafId=null;

    // ミキサー状態（初期値は穏やかに）
    const state = {
      rain: 30, brown: 25, birds: 10, chime: 15,
      mute: {rain:false,brown:false,birds:false,chime:false}
    };
    const nodes = {
      rain: null, brown: null,
      birds: {gain:null, timers:[]},
      chime: {gain:null, timer:null}
    };

    function clamp(v){ return Math.max(0, Math.min(100, v)); }
    function setVal(name, v){
      state[name] = clamp(v);
      $(name+'Val').textContent = state[name];
      if(nodes[name]){
        const g = nodes[name].gain ? nodes[name].gain : nodes[name];
        const vol = (state.mute[name] ? 0 : state[name]/100);
        g.gain.cancelScheduledValues(ctx.currentTime);
        g.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.05);
      }
    }

    function makeGain(vol=0){
      const g = ctx.createGain();
      g.gain.value = vol;
      g.connect(master);
      return g;
    }

    function createNoise(type='white'){
      const bufferSize = 2 * ctx.sampleRate;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      let lastOut = 0;
      for(let i=0;i<bufferSize;i++){
        const white = Math.random()*2-1;
        if(type==='brown'){
          data[i] = (lastOut + 0.02*white)/1.02; lastOut = data[i]; data[i] *= 3.5;
        } else {
          data[i] = white;
        }
      }
      const src = ctx.createBufferSource();
      src.buffer = buffer; src.loop = true;
      return src;
    }

    /* ===== 音源 ===== */

    // 雨：高域ホワイトノイズをややローパスで柔らかく（常時鳴らしつつ小音量）
    function startRain(){
      const white = createNoise('white');
      const g = makeGain(state.mute.rain?0:state.rain/100);
      const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000; hp.Q.value=0.6;
      const lp = ctx.createBiquadFilter(); lp.type='lowpass';  lp.frequency.value=9000;  lp.Q.value=0.2;
      white.connect(hp).connect(lp).connect(g); white.start();
      nodes.rain = g; nodes.rainSrc=white;
    }

    // ブラウンノイズ：低域寄りの空調感（常時だが控えめ）
    function startBrown(){
      const brown = createNoise('brown');
      const g = makeGain(state.mute.brown?0:state.brown/100);
      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=600; lp.Q.value=0.2;
      brown.connect(lp).connect(g); brown.start();
      nodes.brown = g; nodes.brownSrc=brown;
    }

    // 小鳥：短い一鳴き（たまに）— 音量小さめ、耳障りな高域は軽く制限
    function startBirds(){
      const g = makeGain(state.mute.birds?0:state.birds/100);
      nodes.birds.gain = g;
      function scheduleChirp(){
        if(!running) return;
        const now = ctx.currentTime;
        const inSec = 1 + Math.random()*3; // 1-4s毎
        const t = now + inSec;
        const dur = 0.12 + Math.random()*0.08;

        const o = ctx.createOscillator(); o.type='sine';
        const env = ctx.createGain(); env.gain.value = 0;
        const bp  = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 3200 + Math.random()*1200; bp.Q.value=5;

        o.frequency.value = 1400 + Math.random()*800;
        o.connect(env).connect(bp).connect(g);

        env.gain.setValueAtTime(0, t);
        env.gain.linearRampToValueAtTime(0.7, t + 0.02);
        env.gain.exponentialRampToValueAtTime(0.001, t + dur);

        o.start(t); o.stop(t + dur + 0.01);

        const id = setTimeout(scheduleChirp, (inSec + dur)*1000);
        nodes.birds.timers.push(id);
      }
      scheduleChirp();
    }

    // チャイム：単発の温かい「ぽーん」
    // 連続音・うなり・反響は使わず、1～2つの固定比和音（完全五度）を短く減衰
    function playChime(at = ctx.currentTime + 0.02){
      if(state.mute.chime || state.chime===0) return;
      const g = nodes.chime.gain;
      const env = ctx.createGain(); env.gain.value = 0;

      // 基本：A4=440 か G4=392 を交互に使って単調にならないように
      const basePool = [392, 440]; // G4, A4
      const base = basePool[Math.floor(Math.random()*basePool.length)];
      const fifth = base * 1.5; // 完全五度（ビートを避けるため近接周波数は使わない）

      const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value = base;
      const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value = fifth;

      // 軽いローパスで耳に刺さらないように
      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 1800; lp.Q.value=0.2;

      o1.connect(env); o2.connect(env);
      env.connect(lp).connect(g);

      // エンベロープ（短いアタック→約1.6秒で静かに消える）
      env.gain.setValueAtTime(0, at);
      env.gain.linearRampToValueAtTime(0.25, at + 0.03);
      env.gain.linearRampToValueAtTime(0.22, at + 0.15);
      env.gain.exponentialRampToValueAtTime(0.0008, at + 1.6);

      o1.start(at); o2.start(at);
      o1.stop(at + 1.7); o2.stop(at + 1.7);
    }

    function startChimeLoop(){
      const g = makeGain(state.mute.chime?0:state.chime/100);
      nodes.chime.gain = g;
      function schedule(){
        if(!running) return;
        const gap = chimeRange.lo + Math.random()*(chimeRange.hi - chimeRange.lo);
        playChime();
        nodes.chime.timer = setTimeout(schedule, gap*1000);
      }
      schedule();
    }

    /* ===== 再生制御 ===== */
    function startAll(){
      ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
      master = master || ctx.createGain(); master.gain.value=0.9; master.connect(ctx.destination);

      startRain(); startBrown(); startBirds(); startChimeLoop();

      // 初期ゲイン反映
      setVal('rain', state.rain);
      setVal('brown', state.brown);
      if(nodes.birds.gain) setVal('birds', state.birds);
      if(nodes.chime.gain) setVal('chime', state.chime);
    }

    function stopAll(){
      try{
        if(nodes.rainSrc) nodes.rainSrc.stop();
        if(nodes.brownSrc) nodes.brownSrc.stop();
        (nodes.birds.timers||[]).forEach(id=>clearTimeout(id)); nodes.birds.timers=[];
        if(nodes.chime.timer) clearTimeout(nodes.chime.timer);

        if(ctx && ctx.state!=='closed'){ ctx.close(); }
      }catch{}
      ctx = null; master = null;

      for(const k in nodes){
        if(nodes[k] && nodes[k].gain){ nodes[k].gain = null; }
        if(nodes[k] && nodes[k].timers) nodes[k].timers=[];
      }
    }

    function secFmt(s){ const m = Math.max(0, Math.floor(s/60)); const ss = Math.max(0, Math.floor(s%60)); return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
    function tick(){
      const left = endAt - performance.now();
      const durMs = parseInt($('minutes').value,10)*60*1000;
      const passed = Math.min(durMs, durMs - Math.max(0,left));
      $('prog').style.width = `${(passed/durMs)*100}%`;
      $('remain').textContent = secFmt(Math.max(0, Math.ceil(left/1000)));
      if(left <= 0){ stop(); return; }
      rafId = requestAnimationFrame(tick);
    }
    function play(){
      if(running) return;
      running = true;
      $('play').disabled = true; $('stop').disabled = false;
      startAll();
      endAt = performance.now() + parseInt($('minutes').value,10)*60*1000;
      cancelAnimationFrame(rafId); tick();
    }
    function stop(){
      running = false;
      $('play').disabled = false; $('stop').disabled = true;
      cancelAnimationFrame(rafId);
      $('prog').style.width='0%'; $('remain').textContent = '00:00';
      stopAll();
    }
    $('play').addEventListener('click', play);
    $('stop').addEventListener('click', stop);

    /* ===== ミキサー操作（±5%） ===== */
    function hookMix(name){
      document.querySelector(`[data-inc="${name}"]`).addEventListener('click', ()=> setVal(name, state[name]+5));
      document.querySelector(`[data-dec="${name}"]`).addEventListener('click', ()=> setVal(name, state[name]-5));
      document.querySelector(`[data-mute="${name}"]`).addEventListener('click', ()=>{
        state.mute[name] = !state.mute[name];
        const btn = document.querySelector(`[data-mute="${name}"]`);
        btn.textContent = state.mute[name] ? 'Unmute' : 'Mute';
        setVal(name, state[name]); // apply mute
      });
    }
    ['rain','brown','birds','chime'].forEach(hookMix);

    /* ===== プリセット ===== */
    const PRESETS = {
      calm:  {rain:25,brown:30,birds:8, chime:12},
      rain:  {rain:55,brown:15,birds:5, chime:10},
      focus: {rain:10,brown:55,birds:0, chime:8},
      birds: {rain:15,brown:15,birds:35,chime:10},
      chime: {rain:10,brown:10,birds:5, chime:35}
    };
    function applyPreset(p){
      for(const k of Object.keys(PRESETS[p])){
        state.mute[k]=false;
        const btn = document.querySelector(`[data-mute="${k}"]`);
        if(btn) btn.textContent='Mute';
        setVal(k, PRESETS[p][k]);
      }
      document.querySelectorAll('.chip[data-preset]').forEach(c=>c.classList.remove('active'));
      document.querySelector(`.chip[data-preset="${p}"]`).classList.add('active');
    }
    document.querySelectorAll('.chip[data-preset]').forEach(b=>{
      b.addEventListener('click', ()=> applyPreset(b.dataset.preset));
    });
    applyPreset('calm'); // default

    /* ===== チャイム間隔（±2s、下限3 / 上限12） ===== */
    function refreshChimeLabel(){ $('chimeInfo').textContent = dict[ui].chimeLabel(chimeRange.lo, chimeRange.hi); }
    $('chimeSlow').addEventListener('click', ()=>{
      chimeRange.lo = Math.min(12, chimeRange.lo+1);
      chimeRange.hi = Math.min(14, Math.max(chimeRange.lo+1, chimeRange.hi+1));
      refreshChimeLabel();
    });
    $('chimeFast').addEventListener('click', ()=>{
      chimeRange.lo = Math.max(3, chimeRange.lo-1);
      chimeRange.hi = Math.max(chimeRange.lo+1, chimeRange.hi-1);
      refreshChimeLabel();
    });
    $('chimeOnce').addEventListener('click', ()=>{ if(ctx){ playChime(); } });

  </script>
</body>
</html>
