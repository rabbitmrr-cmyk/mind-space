<!doctype html>
<html lang="ja" data-default-lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>3分サウンド — Mind Space</title>
  <meta name="description" content="やさしい合成音のサウンドスケープ。海・雨・ブラウンノイズ・ソフトトーン・鳥のさえずり・やさしい音楽。±で配分調整、3分タイマー付き。"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.72);backdrop-filter:blur(8px);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .btn{border:1px solid #e2e8f0;border-radius:9999px;padding:.35rem .7rem}
    .btn:disabled{opacity:.5}
    .row{display:grid;grid-template-columns:1fr auto auto auto 68px;gap:.5rem;align-items:center}
    .bar{height:8px;background:linear-gradient(90deg,#bae6fd,#e2e8f0);border-radius:9999px;overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#38bdf8,#60a5fa)}
    .chip{padding:.2rem .6rem;border:1px solid #e2e8f0;border-radius:9999px;background:#fff;font-size:.8rem}
    .chip.active{border-color:#60a5fa;background:#eff6ff}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-white to-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/40 border-b border-slate-200/40">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <a id="homeLink" class="text-sm hover:underline">&larr; ホームへ戻る</a>
      <button id="lang" class="text-xs px-3 py-1 rounded-full border border-slate-200">English</button>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 pb-16">
    <h1 class="text-2xl md:text-3xl font-semibold mt-6" id="h1">3分サウンド</h1>
    <p class="mt-2 text-slate-600" id="lead">やさしい合成音のサウンドスケープ。各要素の配分は±で微調整できます。</p>

    <!-- プレイヤー -->
    <section class="card p-5 mt-4">
      <div class="flex flex-wrap items-center gap-2">
        <button id="play" class="btn">▶ 再生</button>
        <button id="stop" class="btn" disabled>■ 停止</button>
        <span class="text-sm text-slate-500">/</span>
        <label class="text-sm flex items-center gap-2">
          <span id="durLabel">時間</span>
          <select id="minutes" class="border rounded px-2 py-1 text-sm">
            <option value="3">3分</option>
            <option value="5">5分</option>
            <option value="10">10分</option>
          </select>
        </label>
        <span class="ml-auto text-sm mono" id="remain">00:00</span>
      </div>
      <div class="bar mt-3"><div id="prog" class="fill"></div></div>

      <!-- プリセット -->
      <div class="mt-4 flex flex-wrap items-center gap-2 text-sm">
        <span class="text-slate-600" id="presetLabel">プリセット:</span>
        <button class="chip active" data-preset="calm">落ち着き</button>
        <button class="chip" data-preset="sea">海辺</button>
        <button class="chip" data-preset="rain">雨音</button>
        <button class="chip" data-preset="focus">集中</button>
        <button class="chip" data-preset="birds">小鳥</button>
        <button class="chip" data-preset="music">やさしい音楽</button>
      </div>

      <!-- ミキサー -->
      <div class="mt-4 grid gap-2">
        <!-- ラベル / - / + / Mute / 値 -->
        <div class="row">
          <div>海</div>
          <button class="btn" data-dec="ocean">−</button>
          <button class="btn" data-inc="ocean">＋</button>
          <button class="btn" data-mute="ocean">Mute</button>
          <div class="mono text-right"><span id="oceanVal">20</span>%</div>
        </div>
        <div class="row">
          <div>雨</div>
          <button class="btn" data-dec="rain">−</button>
          <button class="btn" data-inc="rain">＋</button>
          <button class="btn" data-mute="rain">Mute</button>
          <div class="mono text-right"><span id="rainVal">30</span>%</div>
        </div>
        <div class="row">
          <div>ブラウンノイズ</div>
          <button class="btn" data-dec="brown">−</button>
          <button class="btn" data-inc="brown">＋</button>
          <button class="btn" data-mute="brown">Mute</button>
          <div class="mono text-right"><span id="brownVal">30</span>%</div>
        </div>
        <div class="row">
          <div>ソフトトーン</div>
          <button class="btn" data-dec="tone">−</button>
          <button class="btn" data-inc="tone">＋</button>
          <button class="btn" data-mute="tone">Mute</button>
          <div class="mono text-right"><span id="toneVal">10</span>%</div>
        </div>
        <div class="row">
          <div>小鳥</div>
          <button class="btn" data-dec="birds">−</button>
          <button class="btn" data-inc="birds">＋</button>
          <button class="btn" data-mute="birds">Mute</button>
          <div class="mono text-right"><span id="birdsVal">10</span>%</div>
        </div>
        <div class="row">
          <div>静かな和音</div>
          <button class="btn" data-dec="music">−</button>
          <button class="btn" data-inc="music">＋</button>
          <button class="btn" data-mute="music">Mute</button>
          <div class="mono text-right"><span id="musicVal">10</span>%</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== base path for Home ===== */
    const isGitHubPages = location.hostname.endsWith('github.io');
    const BASE = isGitHubPages ? '/mind-space' : '';
    document.getElementById('homeLink').href = BASE + '/';

    /* ===== i18n (簡易) ===== */
    const dict = {
      ja:{h1:"3分サウンド",lead:"やさしい合成音のサウンドスケープ。各要素の配分は±で微調整できます。",dur:"時間",preset:"プリセット:",play:"▶ 再生",stop:"■ 停止"},
      en:{h1:"3-minute soundscape",lead:"Gentle synthesized ambience. Adjust each layer with ± mix controls.",dur:"Duration",preset:"Presets:",play:"▶ Play",stop:"■ Stop"}
    };
    const $ = id => document.getElementById(id);
    let ui = navigator.language?.startsWith('en') ? 'en' : 'ja';
    function applyUI(){
      $('h1').textContent = dict[ui].h1;
      $('lead').textContent = dict[ui].lead;
      $('durLabel').textContent = dict[ui].dur;
      $('presetLabel').textContent = dict[ui].preset;
      $('play').textContent = dict[ui].play;
      $('stop').textContent = dict[ui].stop;
      $('lang').textContent = (ui==='ja'?'English':'日本語');
      document.documentElement.lang = ui;
    }
    $('lang').addEventListener('click', ()=>{ ui = (ui==='ja'?'en':'ja'); applyUI(); });
    applyUI();

    /* ===== Web Audio Synth ===== */
    let ctx, master, running=false, endAt=0, rafId=null;

    const state = {
      ocean: 20, rain: 30, brown: 30, tone: 10, birds: 10, music: 10,
      mute: {ocean:false,rain:false,brown:false,tone:false,birds:false,music:false}
    };

    const nodes = {
      ocean: null, rain: null, brown: null, tone: null,
      birds: {gain:null, timers:[]},
      music: {gain:null, timers:[], chordIndex:0}
    };

    function clamp(v){ return Math.max(0, Math.min(100, v)); }
    function setVal(name, v){
      state[name] = clamp(v);
      $(name+'Val').textContent = state[name];
      if(nodes[name]){
        const g = nodes[name].gain ? nodes[name].gain : nodes[name];
        const vol = (state.mute[name] ? 0 : state[name]/100);
        g.gain.cancelScheduledValues(ctx.currentTime);
        g.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.05);
      }
    }

    // Utility: noise source
    function createNoise(type='white'){
      const bufferSize = 2 * ctx.sampleRate;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      let lastOut = 0;
      for(let i=0; i<bufferSize; i++){
        const white = Math.random()*2-1;
        if(type==='brown'){
          data[i] = (lastOut + 0.02 * white) / 1.02;
          lastOut = data[i];
          data[i] *= 3.5; // gain
        } else if(type==='pink'){
          // Voss-McCartney-ish
          data[i] = data[i-1] ? (data[i-1]*0.997 + white*0.003) : white;
        } else {
          data[i] = white;
        }
      }
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      src.loop = true;
      return src;
    }

    function makeGain(vol=0){
      const g = ctx.createGain();
      g.gain.value = vol;
      g.connect(master);
      return g;
    }

    // Ocean: pink noise -> dual filters + slow AM (swell) + random gusts
    function startOcean(){
      const pink = createNoise('pink');
      const g = makeGain(state.mute.ocean?0:state.ocean/100);
      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=600; lp.Q.value=0.5;
      const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=80; hp.Q.value=0.7;
      pink.connect(lp).connect(hp).connect(g);

      // Swell: slow LFO to simulate waves
      const lfo = ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.08 + Math.random()*0.04;
      const lfoGain = ctx.createGain(); lfoGain.gain.value = 0.5; // depth
      lfo.connect(lfoGain).connect(g.gain);
      // Bias so it ebbs-and-flows around current level
      const base = g.gain.value;
      const bias = ctx.createConstantSource(); bias.offset.value = base;
      const sum = ctx.createGain(); sum.gain.value=1;
      bias.connect(sum); lfoGain.connect(sum);
      sum.connect(g.gain);
      bias.start(); lfo.start(); pink.start();

      nodes.ocean = g; nodes.oceanSrc = pink; nodes.oceanLfo = lfo; nodes.oceanBias = bias; nodes.oceanSum=sum;
    }

    // Rain: white noise -> highpass + gentle shelf, light random flutter
    function startRain(){
      const white = createNoise('white');
      const g = makeGain(state.mute.rain?0:state.rain/100);
      const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=4000; hp.Q.value=0.7;
      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=12000; lp.Q.value=0.2;
      white.connect(hp).connect(lp).connect(g);
      // subtle flutter
      const lfo = ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.6;
      const lfoGain = ctx.createGain(); lfoGain.gain.value=0.15;
      lfo.connect(lfoGain).connect(g.gain); lfo.start(); white.start();

      nodes.rain = g; nodes.rainSrc=white; nodes.rainLfo=lfo; nodes.rainLfog=lfoGain;
    }

    // Brown noise (very low, HVAC-like)
    function startBrown(){
      const brown = createNoise('brown');
      const g = makeGain(state.mute.brown?0:state.brown/100);
      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=500; lp.Q.value=0.2;
      brown.connect(lp).connect(g); brown.start();
      nodes.brown = g; nodes.brownSrc=brown;
    }

    // Soft tone: two close sines (binaural-ish beating)
    function startTone(){
      const g = makeGain(state.mute.tone?0:state.tone/100);
      const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value=396;
      const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value=401.2; // gentle beat
      o1.connect(g); o2.connect(g);
      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1200; lp.Q.value=0.1;
      g.connect(lp); lp.connect(master);
      o1.start(); o2.start();
      nodes.tone = g; nodes.toneLP=lp; nodes.toneO1=o1; nodes.toneO2=o2;
    }

    // Birds: random FM chirps with pan
    function startBirds(){
      const g = makeGain(state.mute.birds?0:state.birds/100);
      nodes.birds.gain = g;
      function scheduleChirp(){
        if(!running) return;
        const now = ctx.currentTime;
        const t = now + (Math.random()*2 + 0.8); // next in 0.8-2.8s
        const dur = 0.18 + Math.random()*0.12;

        const carrier = ctx.createOscillator(); carrier.type='sine';
        const mod = ctx.createOscillator(); mod.type='sine';
        const modGain = ctx.createGain();
        const env = ctx.createGain(); env.gain.value = 0;
        const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 3000 + Math.random()*2500; bp.Q.value=6;
        const pan = new (window.StereoPannerNode || window.PannerNode)(ctx, { pan: (Math.random()*2-1) });

        carrier.frequency.value = 1200 + Math.random()*1200;
        mod.frequency.value = 30 + Math.random()*90;
        modGain.gain.value = 300 + Math.random()*400;

        mod.connect(modGain).connect(carrier.frequency);
        carrier.connect(env).connect(bp).connect(pan).connect(g);

        env.gain.setValueAtTime(0, t);
        env.gain.linearRampToValueAtTime(0.9, t + 0.03);
        env.gain.exponentialRampToValueAtTime(0.001, t + dur);

        carrier.start(t); mod.start(t);
        carrier.stop(t + dur + 0.02); mod.stop(t + dur + 0.02);

        // keep reference to clear if needed
        const id = setTimeout(scheduleChirp, (t - now + dur)*1000);
        nodes.birds.timers.push(id);
      }
      // kick off a few
      for(let i=0;i<3;i++) scheduleChirp();
    }

    // Gentle music: slow pad chords (I–vi–IV–V in C)
    const CHORDS = [
      [261.63, 329.63, 392.00], // C major
      [220.00, 261.63, 329.63], // A minor
      [246.94, 329.63, 392.00], // B♭? (approx) / F? keep pleasant
      [293.66, 369.99, 440.00], // D -> A sus feel
    ];
    function startMusic(){
      const g = makeGain(state.mute.music?0:state.music/100);
      nodes.music.gain = g; nodes.music.chordIndex = 0;

      function playChord(time){
        if(!running) return;
        const idx = nodes.music.chordIndex % CHORDS.length;
        const chord = CHORDS[idx];
        const duration = 4.5; // seconds
        chord.forEach((f, i)=>{
          const o = ctx.createOscillator(); o.type='sine'; o.frequency.value = f;
          const env = ctx.createGain(); env.gain.value=0;
          const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1200; lp.Q.value=0.3;

          o.connect(env).connect(lp).connect(g);

          env.gain.setValueAtTime(0, time);
          env.gain.linearRampToValueAtTime(0.18, time+0.8);
          env.gain.linearRampToValueAtTime(0.16, time+duration-0.6);
          env.gain.linearRampToValueAtTime(0.0, time+duration);

          o.start(time); o.stop(time+duration+0.02);
        });
        nodes.music.chordIndex++;
        const id = setTimeout(()=>playChord(ctx.currentTime+0.1), duration*1000);
        nodes.music.timers.push(id);
      }
      playChord(ctx.currentTime+0.05);
    }

    function startAll(){
      ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
      master = master || ctx.createGain(); master.gain.value=0.9; master.connect(ctx.destination);

      startOcean(); startRain(); startBrown(); startTone(); startBirds(); startMusic();
    }

    function stopAll(){
      try{
        ['oceanSrc','rainSrc','brownSrc','toneO1','toneO2'].forEach(k=>{ if(nodes[k]){ try{nodes[k].stop();}catch{}}});
        // clear timers
        [...(nodes.birds?.timers||[]), ...(nodes.music?.timers||[])].forEach(id=>clearTimeout(id));
        nodes.birds.timers=[]; nodes.music.timers=[];
        // rebuild graph by closing and recreating context (safe reset)
        if(ctx && ctx.state!=='closed'){ ctx.close(); }
      }catch{}
      ctx = null; master = null;
      // null out node refs
      for(const k in nodes){
        if(nodes[k] && nodes[k].gain){ nodes[k].gain = null; }
        nodes[k]= (typeof nodes[k]==='object') ? {gain:null,timers:[], chordIndex:0} : null;
      }
    }

    // Play / Stop / Timer
    function secFmt(s){ const m = Math.max(0, Math.floor(s/60)); const ss = Math.max(0, Math.floor(s%60)); return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
    function tick(){
      const left = endAt - performance.now();
      const durMs = parseInt($('minutes').value,10)*60*1000;
      const passed = Math.min(durMs, durMs - Math.max(0,left));
      $('prog').style.width = `${(passed/durMs)*100}%`;
      $('remain').textContent = secFmt(Math.max(0, Math.ceil(left/1000)));
      if(left <= 0){ stop(); return; }
      rafId = requestAnimationFrame(tick);
    }
    function play(){
      if(running) return;
      running = true;
      $('play').disabled = true; $('stop').disabled = false;
      startAll();
      endAt = performance.now() + parseInt($('minutes').value,10)*60*1000;
      cancelAnimationFrame(rafId); tick();
    }
    function stop(){
      running = false;
      $('play').disabled = false; $('stop').disabled = true;
      cancelAnimationFrame(rafId);
      $('prog').style.width='0%'; $('remain').textContent = '00:00';
      stopAll();
    }
    $('play').addEventListener('click', play);
    $('stop').addEventListener('click', stop);

    // Mix controls (±5%)
    function hookMix(name){
      document.querySelector(`[data-inc="${name}"]`).addEventListener('click', ()=> setVal(name, state[name]+5));
      document.querySelector(`[data-dec="${name}"]`).addEventListener('click', ()=> setVal(name, state[name]-5));
      document.querySelector(`[data-mute="${name}"]`).addEventListener('click', ()=>{
        state.mute[name] = !state.mute[name];
        const btn = document.querySelector(`[data-mute="${name}"]`);
        btn.textContent = state.mute[name] ? 'Unmute' : 'Mute';
        setVal(name, state[name]); // apply mute
      });
    }
    ['ocean','rain','brown','tone','birds','music'].forEach(hookMix);

    // Presets
    const PRESETS = {
      calm:  {ocean:15,rain:20,brown:35,tone:10,birds:5, music:15},
      sea:   {ocean:40,rain:5, brown:15,tone:5, birds:5, music:10},
      rain:  {ocean:5, rain:55,brown:20,tone:5, birds:5, music:10},
      focus: {ocean:0, rain:10,brown:55,tone:10,birds:0, music:10},
      birds: {ocean:10,rain:10,brown:15,tone:5, birds:50, music:10},
      music: {ocean:5, rain:10,brown:15,tone:10,birds:5, music:45}
    };
    function applyPreset(p){
      for(const k of Object.keys(PRESETS[p])){
        setVal(k, PRESETS[p][k]);
        state.mute[k]=false;
        const btn = document.querySelector(`[data-mute="${k}"]`);
        if(btn) btn.textContent='Mute';
      }
      document.querySelectorAll('.chip[data-preset]').forEach(c=>c.classList.remove('active'));
      document.querySelector(`.chip[data-preset="${p}"]`).classList.add('active');
    }
    document.querySelectorAll('.chip[data-preset]').forEach(b=>{
      b.addEventListener('click', ()=> applyPreset(b.dataset.preset));
    });
    applyPreset('calm'); // default
  </script>
</body>
</html>
