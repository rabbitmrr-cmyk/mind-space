<!doctype html>
<html lang="ja" data-default-lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>3分サウンド — Mind Space</title>
  <meta name="description" content="耳にやさしい短いサウンド。ホワイト/ピンク/ブラウンノイズと、時々“ポーン”と鳴るチャイム／ピアノ。±で配分と間隔を調整、3分タイマー付き。"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.72);backdrop-filter:blur(8px);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06)}
    .btn{border:1px solid #e2e8f0;border-radius:9999px;padding:.35rem .7rem;background:#fff}
    .btn:disabled{opacity:.5}
    .row{display:grid;grid-template-columns:1fr auto auto auto 68px;gap:.5rem;align-items:center}
    .bar{height:8px;background:linear-gradient(90deg,#bae6fd,#e2e8f0);border-radius:9999px;overflow:hidden}
    .fill{height:100%;width:0;background:linear-gradient(90deg,#38bdf8,#60a5fa)}
    .chip{padding:.2rem .6rem;border:1px solid #e2e8f0;border-radius:9999px;background:#fff;font-size:.8rem}
    .chip.active{border-color:#60a5fa;background:#eff6ff}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-white to-slate-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/40 border-b border-slate-200/40">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <a id="homeLink" class="text-sm hover:underline">&larr; ホームへ戻る</a>
      <button id="lang" class="text-xs px-3 py-1 rounded-full border border-slate-200">English</button>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 pb-16">
    <h1 class="text-2xl md:text-3xl font-semibold mt-6" id="h1">3分サウンド</h1>
    <p class="mt-2 text-slate-600" id="lead">
      連続トーンや反響は使わず、耳にやさしい短い音だけ。ノイズ＋ ときどき鳴る「チャイム」「ピアノ」。
      ±で配分と間隔を調整できます。
    </p>

    <!-- プレイヤー -->
    <section class="card p-5 mt-4">
      <div class="flex flex-wrap items-center gap-2">
        <button id="play" class="btn">▶ 再生</button>
        <button id="stop" class="btn" disabled>■ 停止</button>
        <span class="text-sm text-slate-500">/</span>
        <label class="text-sm flex items-center gap-2">
          <span id="durLabel">時間</span>
          <select id="minutes" class="border rounded px-2 py-1 text-sm">
            <option value="3">3分</option>
            <option value="5">5分</option>
            <option value="10">10分</option>
          </select>
        </label>
        <span class="ml-auto text-sm mono" id="remain">00:00</span>
      </div>
      <div class="bar mt-3"><div id="prog" class="fill"></div></div>

      <!-- プリセット -->
      <div class="mt-4 flex flex-wrap items-center gap-2 text-sm">
        <span class="text-slate-600" id="presetLabel">プリセット:</span>
        <button type="button" class="chip" data-preset="calm">落ち着き</button>
        <button type="button" class="chip" data-preset="rain">雨</button>
        <button type="button" class="chip" data-preset="focus">集中</button>
        <button type="button" class="chip" data-preset="chime">チャイム中心</button>
        <button type="button" class="chip" data-preset="piano">ピアノ中心</button>
      </div>

      <!-- ミキサー -->
      <div class="mt-4 grid gap-2">
        <div class="row">
          <div>ホワイトノイズ</div>
          <button class="btn" data-dec="white">−</button>
          <button class="btn" data-inc="white">＋</button>
          <button class="btn" data-mute="white">Mute</button>
          <div class="mono text-right"><span id="whiteVal">20</span>%</div>
        </div>
        <div class="row">
          <div>ピンクノイズ</div>
          <button class="btn" data-dec="pink">−</button>
          <button class="btn" data-inc="pink">＋</button>
          <button class="btn" data-mute="pink">Mute</button>
          <div class="mono text-right"><span id="pinkVal">25</span>%</div>
        </div>
        <div class="row">
          <div>ブラウンノイズ</div>
          <button class="btn" data-dec="brown">−</button>
          <button class="btn" data-inc="brown">＋</button>
          <button class="btn" data-mute="brown">Mute</button>
          <div class="mono text-right"><span id="brownVal">25</span>%</div>
        </div>
        <div class="row">
          <div>チャイム</div>
          <button class="btn" data-dec="chime">−</button>
          <button class="btn" data-inc="chime">＋</button>
          <button class="btn" data-mute="chime">Mute</button>
          <div class="mono text-right"><span id="chimeVal">20</span>%</div>
        </div>
        <div class="row">
          <div>ピアノ</div>
          <button class="btn" data-dec="piano">−</button>
          <button class="btn" data-inc="piano">＋</button>
          <button class="btn" data-mute="piano">Mute</button>
          <div class="mono text-right"><span id="pianoVal">18</span>%</div>
        </div>
      </div>

      <!-- 間隔 -->
      <div class="mt-4 grid gap-2" style="grid-template-columns:auto auto auto auto 1fr;">
        <div class="text-sm">チャイム間隔</div>
        <button class="btn" id="chimeSlow">−</button>
        <button class="btn" id="chimeFast">＋</button>
        <button class="btn" id="chimeOnce">今すぐ鳴らす</button>
        <div class="mono text-right text-sm"><span id="chimeInfo">約 5–8 秒に1回</span></div>
      </div>
      <div class="mt-2 grid gap-2" style="grid-template-columns:auto auto auto auto 1fr;">
        <div class="text-sm">ピアノ間隔</div>
        <button class="btn" id="pianoSlow">−</button>
        <button class="btn" id="pianoFast">＋</button>
        <button class="btn" id="pianoOnce">今すぐ鳴らす</button>
        <div class="mono text-right text-sm"><span id="pianoInfo">約 7–12 秒に1回</span></div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Home link base ===== */
    const isGitHubPages = location.hostname.endsWith('github.io');
    const BASE = isGitHubPages ? '/mind-space' : '';
    document.getElementById('homeLink').href = BASE + '/';

    /* ===== i18n (簡易) ===== */
    const dict = {
      ja:{h1:"3分サウンド",lead:"ノイズ ＋ ときどき鳴るチャイム/ピアノ。±で配分と間隔を調整できます。",dur:"時間",preset:"プリセット:",play:"▶ 再生",stop:"■ 停止",now:"今すぐ鳴らす",label:(lo,hi)=>`約 ${lo}–${hi} 秒に1回`},
      en:{h1:"3-minute soundscape",lead:"Noise (white/pink/brown) + occasional chime/piano. Adjust mix and intervals with ±.",dur:"Duration",preset:"Presets:",play:"▶ Play",stop:"■ Stop",now:"Play now",label:(lo,hi)=>`every ~${lo}-${hi}s`}
    };
    const $ = id => document.getElementById(id);
    let ui = navigator.language?.startsWith('en') ? 'en' : 'ja';
    function applyUI(){
      $('h1').textContent = dict[ui].h1;
      $('lead').textContent = dict[ui].lead;
      $('durLabel').textContent = dict[ui].dur;
      $('presetLabel').textContent = dict[ui].preset;
      $('play').textContent = dict[ui].play;
      $('stop').textContent = dict[ui].stop;
      $('lang').textContent = (ui==='ja'?'English':'日本語');
      $('chimeOnce').textContent = dict[ui].now;
      $('pianoOnce').textContent = dict[ui].now;
      $('chimeInfo').textContent = dict[ui].label(chimeRange.lo, chimeRange.hi);
      $('pianoInfo').textContent = dict[ui].label(pianoRange.lo, pianoRange.hi);
      document.documentElement.lang = ui;
    }
    $('lang').addEventListener('click', ()=>{ ui = (ui==='ja'?'en':'ja'); applyUI(); });

    /* ===== タイマー表示 ===== */
    let running=false, endAt=0, rafId=null;
    function secFmt(s){ const m = Math.max(0, Math.floor(s/60)); const ss = Math.max(0, Math.floor(s%60)); return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
    function tick(){
      const left = endAt - performance.now();
      const durMs = parseInt($('minutes').value,10)*60*1000;
      const passed = Math.min(durMs, durMs - Math.max(0,left));
      $('prog').style.width = `${(passed/durMs)*100}%`;
      $('remain').textContent = secFmt(Math.max(0, Math.ceil(left/1000)));
      if(left <= 0){ stop(); return; }
      rafId = requestAnimationFrame(tick);
    }

    /* ===== Web Audio Core ===== */
    let ctx, master;

    // 状態
    const state = {
      white: 20, pink: 25, brown: 25, chime: 20, piano: 18,
      mute: {white:false,pink:false,brown:false,chime:false,piano:false}
    };
    const nodes = {
      white:{src:null,gain:null}, pink:{src:null,gain:null}, brown:{src:null,gain:null},
      chime:{gain:null,timer:null}, piano:{gain:null,timer:null}
    };

    const chimeRange = {lo:5, hi:8};
    const pianoRange = {lo:7, hi:12};

    function refreshLabels(){
      $('chimeInfo').textContent = dict[ui].label(chimeRange.lo, chimeRange.hi);
      $('pianoInfo').textContent = dict[ui].label(pianoRange.lo, pianoRange.hi);
    }

    function makeGain(vol=0){
      const g = ctx.createGain();
      g.gain.value = vol;
      g.connect(master);
      return g;
    }

    function setVal(name, v){
      state[name] = Math.max(0, Math.min(100, v));
      $(name+'Val').textContent = state[name];
      const g = nodes[name].gain;
      if(!g) return;
      // チャイム/ピアノは少し聞こえやすい係数を掛ける（0.0–1.5）
      const boost = (name==='chime' || name==='piano') ? 1.3 : 1.0;
      const vol = (state.mute[name] ? 0 : Math.min(1.5, (state[name]/100)*boost));
      g.gain.cancelScheduledValues(ctx.currentTime);
      g.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.05);
    }

    function createNoiseBuffer(kind){
      const length = 2 * ctx.sampleRate;
      const buffer = ctx.createBuffer(1, length, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      if(kind==='white'){
        for(let i=0;i<length;i++){ data[i] = Math.random()*2-1; }
      }else if(kind==='pink'){
        // Voss-McCartney 方式の簡易ピンク
        let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
        for(let i=0;i<length;i++){
          const white = Math.random()*2-1;
          b0 = 0.99886*b0 + white*0.0555179;
          b1 = 0.99332*b1 + white*0.0750759;
          b2 = 0.96900*b2 + white*0.1538520;
          b3 = 0.86650*b3 + white*0.3104856;
          b4 = 0.55000*b4 + white*0.5329522;
          b5 = -0.7616*b5 - white*0.0168980;
          const pink = b0+b1+b2+b3+b4+b5+b6 + white*0.5362;
          b6 = white*0.115926;
          data[i] = pink * 0.11;
        }
      }else{ // brown
        let last=0;
        for(let i=0;i<length;i++){
          const white = Math.random()*2-1;
          data[i] = (last + 0.02*white)/1.02; last = data[i]; data[i]*=3.5;
        }
      }
      return buffer;
    }

    function startNoise(kind, toneShape='soft'){
      const src = ctx.createBufferSource();
      src.buffer = createNoiseBuffer(kind);
      src.loop = true;

      // 角の取れた帯域で耳当たりを軽く
      const shaper = ctx.createBiquadFilter();
      if(kind==='white'){ shaper.type='lowpass'; shaper.frequency.value=6500; shaper.Q.value=0.2; }
      if(kind==='pink'){ shaper.type='lowpass'; shaper.frequency.value=5500; shaper.Q.value=0.2; }
      if(kind==='brown'){ shaper.type='lowpass'; shaper.frequency.value=500; shaper.Q.value=0.3; }

      const g = makeGain((state[kind]/100));
      src.connect(shaper).connect(g);
      src.start();
      nodes[kind].src = src;
      nodes[kind].gain = g;
      setVal(kind, state[kind]); // 反映
    }

    // 単発チャイム
    function playChime(at = ctx.currentTime + 0.02){
      if(state.mute.chime || state.chime===0) return;
      const g = nodes.chime.gain;
      const env = ctx.createGain(); env.gain.value = 0;

      // 心地よい音程プール（うなり回避の固定比）
      const basePool = [392, 440, 494, 523.25]; // G4, A4, B4, C5
      const base = basePool[Math.floor(Math.random()*basePool.length)];
      const fifth = base * 1.5;

      const o1 = ctx.createOscillator(); o1.type='sine'; o1.frequency.value = base;
      const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value = fifth;

      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 1800; lp.Q.value=0.2;

      o1.connect(env); o2.connect(env);
      env.connect(lp).connect(g);

      env.gain.setValueAtTime(0, at);
      env.gain.linearRampToValueAtTime(0.35, at + 0.03);   // 少しだけ大きめに
      env.gain.linearRampToValueAtTime(0.30, at + 0.15);
      env.gain.exponentialRampToValueAtTime(0.0007, at + 1.6);

      o1.start(at); o2.start(at);
      o1.stop(at + 1.7); o2.stop(at + 1.7);
    }

    // 単発ピアノ（疑似）：短いアタック＆素早い減衰、倍音少なめで柔らかい
    function playPiano(at = ctx.currentTime + 0.02){
      if(state.mute.piano || state.piano===0) return;
      const g = nodes.piano.gain;
      const env = ctx.createGain(); env.gain.value = 0;

      // やさしい音域（C4〜A4）
      const scale = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00];
      const f0 = scale[Math.floor(Math.random()*scale.length)];

      const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value = f0;
      // ごく薄い倍音（音色付け）— beatingを避けるため周波数は固定比
      const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.value = f0*2;

      const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 2200; lp.Q.value=0.3;

      o1.connect(env); o2.connect(env);
      env.connect(lp).connect(g);

      // 速いアタック→短めに減衰（ピアノ風）
      env.gain.setValueAtTime(0, at);
      env.gain.linearRampToValueAtTime(0.28, at + 0.015);
      env.gain.exponentialRampToValueAtTime(0.0009, at + 0.8);

      o1.start(at); o2.start(at);
      o1.stop(at + 0.85); o2.stop(at + 0.85);
    }

    function startChimeLoop(){
      const g = makeGain((state.chime/100)*1.3);
      nodes.chime.gain = g;
      const schedule = ()=>{
        if(!running) return;
        playChime();
        const gap = chimeRange.lo + Math.random()*(chimeRange.hi - chimeRange.lo);
        nodes.chime.timer = setTimeout(schedule, gap*1000);
      };
      schedule();
      setVal('chime', state.chime);
    }

    function startPianoLoop(){
      const g = makeGain((state.piano/100)*1.2);
      nodes.piano.gain = g;
      const schedule = ()=>{
        if(!running) return;
        playPiano();
        const gap = pianoRange.lo + Math.random()*(pianoRange.hi - pianoRange.lo);
        nodes.piano.timer = setTimeout(schedule, gap*1000);
      };
      schedule();
      setVal('piano', state.piano);
    }

    function startAll(){
      ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
      master = master || ctx.createGain(); master.gain.value=0.9; master.connect(ctx.destination);

      startNoise('white');
      startNoise('pink');
      startNoise('brown');
      startChimeLoop();
      startPianoLoop();
    }

    function stopAll(){
      try{
        ['white','pink','brown'].forEach(k=>{
          if(nodes[k].src){ nodes[k].src.stop(); nodes[k].src.disconnect(); nodes[k].src=null; }
          if(nodes[k].gain){ nodes[k].gain.disconnect(); nodes[k].gain=null; }
        });
        if(nodes.chime.timer) clearTimeout(nodes.chime.timer);
        if(nodes.piano.timer) clearTimeout(nodes.piano.timer);
        if(nodes.chime.gain){ nodes.chime.gain.disconnect(); nodes.chime.gain=null; }
        if(nodes.piano.gain){ nodes.piano.gain.disconnect(); nodes.piano.gain=null; }
        if(ctx && ctx.state!=='closed'){ ctx.close(); }
      }catch{}
      ctx = null; master = null;
    }

    function play(){
      if(running) return;
      running = true;
      $('play').disabled = true; $('stop').disabled = false;
      startAll();
      endAt = performance.now() + parseInt($('minutes').value,10)*60*1000;
      cancelAnimationFrame(rafId); tick();
    }
    function stop(){
      running = false;
      $('play').disabled = false; $('stop').disabled = true;
      cancelAnimationFrame(rafId);
      $('prog').style.width='0%'; $('remain').textContent = '00:00';
      stopAll();
    }
    $('play').addEventListener('click', play);
    $('stop').addEventListener('click', stop);

    /* ===== ミキサー操作（±5% / Mute） ===== */
    function hookMix(name){
      document.querySelector(`[data-inc="${name}"]`).addEventListener('click', ()=> setVal(name, state[name]+5));
      document.querySelector(`[data-dec="${name}"]`).addEventListener('click', ()=> setVal(name, state[name]-5));
      document.querySelector(`[data-mute="${name}"]`).addEventListener('click', (e)=>{
        state.mute[name] = !state.mute[name];
        e.currentTarget.textContent = state.mute[name] ? 'Unmute' : 'Mute';
        setVal(name, state[name]);
      });
    }
    ['white','pink','brown','chime','piano'].forEach(hookMix);

    /* ===== プリセット ===== */
    const PRESETS = {
      calm:  {white:10,pink:30,brown:30,chime:12,piano:10},
      rain:  {white:15,pink:20,brown:50,chime:10,piano:8},
      focus: {white:10,pink:45,brown:30,chime:6, piano:6},
      chime: {white:8, pink:18,brown:18,chime:35,piano:10},
      piano: {white:8, pink:20,brown:20,chime:12,piano:35}
    };
    function applyPreset(key){
      const p = PRESETS[key]; if(!p) return;
      for(const k of Object.keys(p)){
        state.mute[k]=false;
        const btn = document.querySelector(`[data-mute="${k}"]`);
        if(btn) btn.textContent='Mute';
        setVal(k, p[k]);
      }
      document.querySelectorAll('.chip[data-preset]').forEach(c=>c.classList.remove('active'));
      const target = document.querySelector(`.chip[data-preset="${key}"]`);
      if(target){ target.classList.add('active'); }
    }
    document.querySelectorAll('.chip[data-preset]').forEach(b=>{
      // buttonを明示（Netlifyでリンク扱いされないように）
      b.setAttribute('type','button');
      b.addEventListener('click', ()=> applyPreset(b.dataset.preset), {passive:true});
    });
    applyPreset('calm'); // 既定

    /* ===== 間隔（チャイム/ピアノ） ===== */
    function clampInt(v, lo, hi){ return Math.max(lo, Math.min(hi, v|0)); }
    function labelUpdate(){ refreshLabels(); }

    $('chimeSlow').addEventListener('click', ()=>{
      chimeRange.lo = clampInt(chimeRange.lo+1, 3, 12);
      chimeRange.hi = clampInt(Math.max(chimeRange.hi+1, chimeRange.lo+1), chimeRange.lo+1, 16);
      labelUpdate();
    });
    $('chimeFast').addEventListener('click', ()=>{
      chimeRange.lo = clampInt(chimeRange.lo-1, 3, 12);
      chimeRange.hi = clampInt(Math.max(chimeRange.lo+1, chimeRange.hi-1), chimeRange.lo+1, 16);
      labelUpdate();
    });
    $('chimeOnce').addEventListener('click', ()=>{ if(ctx){ playChime(); } });

    $('pianoSlow').addEventListener('click', ()=>{
      pianoRange.lo = clampInt(pianoRange.lo+1, 4, 16);
      pianoRange.hi = clampInt(Math.max(pianoRange.hi+1, pianoRange.lo+1), pianoRange.lo+1, 20);
      labelUpdate();
    });
    $('pianoFast').addEventListener('click', ()=>{
      pianoRange.lo = clampInt(pianoRange.lo-1, 4, 16);
      pianoRange.hi = clampInt(Math.max(pianoRange.lo+1, pianoRange.hi-1), pianoRange.lo+1, 20);
      labelUpdate();
    });
    $('pianoOnce').addEventListener('click', ()=>{ if(ctx){ playPiano(); } });

    /* ===== 初期UI ===== */
    (function initUI(){
      const isEn = navigator.language?.startsWith('en');
      ui = isEn ? 'en' : 'ja';
      applyUI();
      // 値表示同期
      ['white','pink','brown','chime','piano'].forEach(k=>$(k+'Val').textContent = state[k]);
    })();
  </script>
</body>
</html>
